<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syg Ku Tintakuu</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíñ</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow: hidden; }
        #dynamic-bg { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -20; background-size: 400% 400%; animation: gradientGerak 8s ease infinite; transition: background-image 0.5s ease-in-out; }
        @keyframes gradientGerak { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .theme-ungu { background-image: linear-gradient(-45deg, #240046, #7b2cbf, #ff006e, #3c096c); }
        .theme-cyber { background-image: linear-gradient(-45deg, #ff00cc, #333399, #00ccff, #ffcc00); }
        .theme-lava { background-image: linear-gradient(-45deg, #590d22, #a4133c, #ff4d6d, #ffb703); }
        .theme-ocean { background-image: linear-gradient(-45deg, #000428, #004e92, #00c6ff, #0072ff); }
        .theme-sunset { background-image: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); }
        
        .glass { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        
        #chat-box::-webkit-scrollbar { width: 4px; }
        #chat-box::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 10px; }
        
        .photo-floater { position: absolute; bottom: -300px; pointer-events: none; z-index: 50; animation: floatUpPhoto linear forwards; background-color: white; padding: 8px 8px 25px 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.25); border-radius: 4px; transform-origin: center; }
        .photo-floater img { width: 100%; height: 100%; object-fit: cover; border-radius: 2px; display: block; }
        @keyframes floatUpPhoto { 0% { transform: translateY(0) rotate(var(--rot-start)) scale(0.8); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-120vh) rotate(var(--rot-end)) scale(1); opacity: 0; } }
        
        .heart-img { position: absolute; z-index: -5; pointer-events: none; animation: floatHeart linear forwards; opacity: 0.8; filter: drop-shadow(0 0 10px rgba(255,255,255,0.4)); }
        @keyframes floatHeart { 0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 20% { opacity: 0.7; } 80% { opacity: 0.7; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }

        /* Tombol Action Chat (Reply/React) */
        .msg-actions { opacity: 0; transition: opacity 0.2s; }
        .chat-row:hover .msg-actions { opacity: 1; }
        
        /* Reaction Picker */
        .reaction-picker { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex items-center justify-center relative overflow-hidden">

    <div id="dynamic-bg" class="theme-ungu"></div>
    <div id="heart-container" class="absolute inset-0 w-full h-full overflow-hidden pointer-events-none"></div>

    <div class="absolute top-6 right-6 z-[60] flex gap-2">
        <button id="btn-party" onclick="muncratkan()" class="bg-white/20 hover:bg-white/40 text-white w-14 h-14 rounded-full backdrop-blur-md border border-white/30 shadow-lg active:scale-90 transition text-2xl animate__animated" title="Show Love!">üì∏</button>
        <button onclick="changeTheme()" class="bg-white/20 hover:bg-white/40 text-white px-5 py-3 rounded-full backdrop-blur-md border border-white/30 shadow-lg active:scale-95 transition font-bold text-sm flex items-center gap-2"><span>üé®</span> <span id="btn-text">Ganti Vibe</span></button>
    </div>

    <div class="glass p-8 md:p-12 rounded-[2.5rem] text-center shadow-2xl w-[90%] max-w-md relative z-10 flex flex-col max-h-[85vh] border-t border-l border-white/40">
        <div class="mb-4 animate__animated animate__fadeInDown">
            <h1 class="text-6xl md:text-7xl font-extrabold text-white tracking-tighter leading-none drop-shadow-lg">syg ku<span class="inline-block animate__animated animate__heartBeat animate__infinite text-purple-300 text-5xl align-middle ml-2">üíñ</span></h1>
            <h1 class="text-5xl md:text-6xl font-extrabold text-white tracking-tighter leading-none drop-shadow-lg mt-2">tintakuu<span class="inline-block animate__animated animate__heartBeat animate__infinite text-pink-300 text-5xl align-middle ml-2" style="animation-delay: 0.5s">üíñ</span></h1>
            <p class="text-white/80 text-xs font-bold tracking-[0.4em] mt-4 uppercase">My Favorite Person</p>
        </div>
        
        <div class="flex-1 flex flex-col min-h-0 bg-black/20 rounded-2xl p-4 border border-white/10 shadow-inner relative">
            <div id="chat-box" class="flex-1 overflow-y-auto mb-3 pr-2 space-y-4">
                <div class="text-center text-white/50 text-xs py-10 italic">Menghubungkan ke hati... ‚è≥</div>
            </div>

            <div id="reply-banner" class="hidden flex items-center justify-between bg-white/10 backdrop-blur-md p-2 rounded-lg mb-2 border-l-4 border-purple-400">
                <div class="text-left text-xs text-white">
                    <span class="font-bold text-purple-300 block mb-1">Membalas <span id="reply-to-name">...</span></span>
                    <span id="reply-text" class="italic opacity-70 line-clamp-1">...</span>
                </div>
                <button onclick="cancelReply()" class="text-white/50 hover:text-white px-2">‚úï</button>
            </div>

            <div class="flex gap-2 relative mt-1">
                <input type="text" id="msg-input" class="w-full bg-white/10 border border-white/20 rounded-full pl-5 pr-12 py-3 text-white placeholder-white/60 focus:outline-none focus:bg-white/25 focus:border-purple-300 transition-all text-sm font-medium shadow-sm" placeholder="Kirim pesan..." autocomplete="off">
                <button id="send-btn" class="absolute right-1 top-1 bottom-1 bg-gradient-to-br from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 text-white w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg group active:scale-90">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 group-hover:rotate-45 transition-transform"><path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" /></svg>
                </button>
            </div>
            
            <div id="reaction-modal" class="hidden absolute bottom-16 left-0 right-0 z-50 flex justify-center">
                <div class="bg-white rounded-full p-2 shadow-2xl flex gap-2 animate__animated animate__bounceIn reaction-picker">
                    <button onclick="pilihReaction('üëç')" class="hover:scale-125 transition text-2xl">üëç</button>
                    <button onclick="pilihReaction('‚ù§Ô∏è')" class="hover:scale-125 transition text-2xl">‚ù§Ô∏è</button>
                    <button onclick="pilihReaction('üòÇ')" class="hover:scale-125 transition text-2xl">üòÇ</button>
                    <button onclick="pilihReaction('üòÆ')" class="hover:scale-125 transition text-2xl">üòÆ</button>
                    <button onclick="pilihReaction('üò¢')" class="hover:scale-125 transition text-2xl">üò¢</button>
                    <button onclick="pilihReaction('üôè')" class="hover:scale-125 transition text-2xl">üôè</button>
                    <button onclick="pilihReaction('ü§û')" class="hover:scale-125 transition text-2xl">ü§û</button>
                    <button onclick="pilihReaction('üëß')" class="hover:scale-125 transition text-2xl">üëß</button>
                    <button onclick="pilihReaction('üßí')" class="hover:scale-125 transition text-2xl">üßí</button>
                    <button onclick="closeReaction()" class="text-gray-400 text-sm ml-2 px-2">‚úï</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const themes = ['theme-ungu', 'theme-cyber', 'theme-lava', 'theme-ocean', 'theme-sunset'];
        let currentIndex = 0;
        function changeTheme() {
            currentIndex = (currentIndex + 1) % themes.length;
            const bg = document.getElementById('dynamic-bg');
            bg.classList.remove(...themes); bg.classList.add(themes[currentIndex]);
            const txt = document.getElementById('btn-text');
            txt.innerText = "‚ú® Magic!"; setTimeout(() => txt.innerText = "Ganti Vibe", 500);
        }

        const myPhotos = [];
        for(let i = 1; i <= 10; i++) { myPhotos.push(`foto (${i}).jpg`); }

        function spawnPhoto(isFast = false) {
            const frame = document.createElement('div'); frame.classList.add('photo-floater');
            const img = document.createElement('img');
            img.src = myPhotos[Math.floor(Math.random() * myPhotos.length)];
            img.onerror = function() { this.style.display = 'none'; frame.innerText = "Foto 404"; };
            frame.appendChild(img);
            frame.style.left = Math.random() * 85 + 'vw';
            frame.style.width = (Math.floor(Math.random() * 90) + 130) + 'px';
            frame.style.setProperty('--rot-start', (Math.random() * 40 - 20) + 'deg');
            frame.style.setProperty('--rot-end', (Math.random() * 360) + 'deg');
            const duration = isFast ? (Math.random() * 3 + 2) : (Math.random() * 5 + 5);
            frame.style.animationDuration = duration + 's';
            document.body.appendChild(frame);
            setTimeout(() => { frame.remove(); }, duration * 1000);
        }

        function muncratkan() {
            const btn = document.getElementById('btn-party'); btn.classList.add('animate__rubberBand');
            setTimeout(() => btn.classList.remove('animate__rubberBand'), 800);
            for(let i=0; i<12; i++) { setTimeout(() => { spawnPhoto(true); }, i * 150); }
        }
        setInterval(() => spawnPhoto(false), 3000);

        const heartSrc = "https://upload.wikimedia.org/wikipedia/commons/4/42/Love_Heart_SVG.svg";
        function spawnHeart() {
            const img = document.createElement('img'); img.src = heartSrc; img.classList.add('heart-img');
            img.style.left = ((Math.random() * 120) - 10) + 'vw';
            img.style.width = ((Math.random() * 60) + 20) + 'px';
            img.style.filter = `hue-rotate(${Math.floor(Math.random() * 360)}deg) drop-shadow(0 0 5px rgba(255,255,255,0.5))`;
            const duration = (Math.random() * 6) + 6; img.style.animationDuration = duration + 's';
            document.getElementById('heart-container').appendChild(img);
            setTimeout(() => { img.remove(); }, duration * 1000);
        }
        setInterval(spawnHeart, 600);
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9Ofp0v-rc0Z8iK98APBXrA3mSA9K_5X0",
            authDomain: "sayang-ff5b2.firebaseapp.com",
            projectId: "sayang-ff5b2",
            storageBucket: "sayang-ff5b2.firebasestorage.app",
            messagingSenderId: "615657253892",
            appId: "1:615657253892:web:768e3a8690fa0547a69951"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const replyBanner = document.getElementById('reply-banner');
        const replyToNameEl = document.getElementById('reply-to-name');
        const replyTextEl = document.getElementById('reply-text');
        
        let myUid = null;
        let replyData = null; // Menyimpan data pesan yang lagi direply
        let activeMsgIdForReaction = null; // Menyimpan ID pesan yg lagi mau dikasih reaction

        signInAnonymously(auth).catch((error) => console.error("Login Gagal:", error));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                setupRealtimeListener();
            }
        });

        // 1. KIRIM PESAN (SUPPORT REPLY)
        async function kirimPesan() {
            const text = msgInput.value;
            if (text.trim() === "") return;

            const btnText = sendBtn.innerHTML;
            sendBtn.innerHTML = "‚è≥";
            sendBtn.disabled = true;

            const newMessage = {
                text: text,
                uid: myUid,
                createdAt: serverTimestamp()
            };

            // Kalau lagi reply, tambahkan data reply
            if (replyData) {
                newMessage.replyTo = replyData;
            }

            try {
                await addDoc(collection(db, "messages"), newMessage);
                msgInput.value = "";
                cancelReply(); // Reset mode reply
            } catch (e) {
                alert("Gagal kirim: " + e.message);
            } finally {
                sendBtn.innerHTML = btnText;
                sendBtn.disabled = false;
            }
        }

        sendBtn.addEventListener('click', kirimPesan);
        msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') kirimPesan(); });

        // 2. LOGIC REPLY
        window.startReply = (text, senderName) => {
            replyData = { text: text, sender: senderName };
            replyToNameEl.innerText = senderName;
            replyTextEl.innerText = text;
            replyBanner.classList.remove('hidden');
            msgInput.focus();
        };

        window.cancelReply = () => {
            replyData = null;
            replyBanner.classList.add('hidden');
        };

        // 3. LOGIC REACTION
        window.openReaction = (msgId) => {
            activeMsgIdForReaction = msgId;
            document.getElementById('reaction-modal').classList.remove('hidden');
        };

        window.closeReaction = () => {
            activeMsgIdForReaction = null;
            document.getElementById('reaction-modal').classList.add('hidden');
        };

        window.pilihReaction = async (emoji) => {
            if (!activeMsgIdForReaction) return;
            
            const docRef = doc(db, "messages", activeMsgIdForReaction);
            try {
                // Simpan reaction sebagai Map: { "UserID": "Emoji" }
                // Biar satu user cuma bisa kasih 1 react per pesan
                const updateData = {};
                updateData[`reactions.${myUid}`] = emoji;
                
                await updateDoc(docRef, updateData);
                closeReaction();
            } catch (e) {
                console.error("Gagal kasih reaction:", e);
            }
        };

        // 4. RENDER CHAT
        function setupRealtimeListener() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            
            onSnapshot(q, (snapshot) => {
                chatBox.innerHTML = "";
                
                if (snapshot.empty) {
                    chatBox.innerHTML = '<div class="text-center text-white/50 text-xs py-10 italic">Belum ada pesan...<br>Ayo mulai duluan!</div>';
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const msgId = docSnap.id;
                    const isMe = data.uid === myUid; 
                    const senderName = isMe ? "Aku" : "Sayang ‚ù§Ô∏è";

                    // Hitung Reactions
                    let reactionsHtml = "";
                    if (data.reactions) {
                        const emojis = Object.values(data.reactions);
                        // Ambil unique emojis biar ga penuh kalau sama semua
                        const uniqueEmojis = [...new Set(emojis)]; 
                        if (uniqueEmojis.length > 0) {
                            reactionsHtml = `
                                <div class="absolute -bottom-3 ${isMe ? 'right-2' : 'left-2'} bg-white rounded-full px-2 py-0.5 text-xs shadow-md border border-gray-200">
                                    ${uniqueEmojis.join('')} <span class="text-[9px] text-gray-500">${emojis.length}</span>
                                </div>
                            `;
                        }
                    }

                    // Tampilan Reply Quote
                    let replyHtml = "";
                    if (data.replyTo) {
                        replyHtml = `
                            <div class="bg-black/10 rounded-lg p-2 mb-1 border-l-2 border-white/50 text-xs">
                                <div class="font-bold opacity-80 mb-0.5">${data.replyTo.sender}</div>
                                <div class="opacity-60 line-clamp-1">${escapeHtml(data.replyTo.text)}</div>
                            </div>
                        `;
                    }

                    // Tombol Action (Reply & React)
                    // Kita taruh di samping bubble, muncul pas hover
                    const actionBtns = `
                        <div class="msg-actions flex gap-1 items-center px-2 text-white/50">
                            <button onclick="startReply('${escapeHtml(data.text)}', '${senderName}')" class="hover:text-white hover:scale-110 transition" title="Balas">‚Ü©Ô∏è</button>
                            <button onclick="openReaction('${msgId}')" class="hover:text-white hover:scale-110 transition" title="React">üòÄ</button>
                        </div>
                    `;

                    const div = document.createElement('div');
                    
                    if (isMe) {
                        // KANAN (AKU)
                        div.className = "flex flex-col items-end animate__animated animate__fadeInUp animate__faster chat-row group";
                        div.innerHTML = `
                            <span class="text-[10px] text-white/70 mr-2 mb-1">Aku</span>
                            <div class="flex flex-row-reverse items-end">
                                <div class="relative bg-purple-500/60 backdrop-blur-md text-white px-4 py-2 rounded-2xl rounded-tr-none border border-white/30 shadow-md max-w-[80%] text-left min-w-[100px]">
                                    ${replyHtml}
                                    <p class="text-sm font-medium leading-relaxed">${escapeHtml(data.text)}</p>
                                    ${reactionsHtml}
                                </div>
                                ${actionBtns}
                            </div>
                        `;
                    } else {
                        // KIRI (DIA)
                        div.className = "flex flex-col items-start animate__animated animate__fadeInUp animate__faster chat-row group";
                        div.innerHTML = `
                            <span class="text-[10px] text-white/70 ml-2 mb-1">Sayang ‚ù§Ô∏è</span>
                            <div class="flex items-end">
                                <div class="relative bg-white/20 backdrop-blur-md text-white px-4 py-2 rounded-2xl rounded-tl-none border border-white/20 shadow-sm max-w-[80%] text-left min-w-[100px]">
                                    ${replyHtml}
                                    <p class="text-sm font-medium leading-relaxed">${escapeHtml(data.text)}</p>
                                    ${reactionsHtml}
                                </div>
                                ${actionBtns}
                            </div>
                        `;
                    }
                    
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function escapeHtml(text) {
            return text ? text.replace(/</g, "&lt;") : '';
        }
    </script>
</body>
</html>